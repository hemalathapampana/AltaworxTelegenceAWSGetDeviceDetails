# AltaworxTelegenceAWSGetDeviceDetails Lambda Analysis

## Overview
The **AltaworxTelegenceAWSGetDeviceDetails** Lambda function is responsible for processing device details from the Telegence API in batches. It processes SQS messages to either initialize device detail processing or process specific groups of subscriber numbers.

## 1. SQS Message Triggers for Device Details Processing

### Initial Trigger Source
The first SQS message to start device details processing is **triggered by the AltaworxTelegenceAWSGetDevices Lambda function**. Based on the provided code snippet from the AltaworxTelegenceAWSGetDevices Lambda:

```csharp
// From AltaworxTelegenceAWSGetDevices Lambda
private string DeviceDetailQueueURL = Environment.GetEnvironmentVariable("TelegenceDeviceDetailQueueURL");
```

The **AltaworxTelegenceAWSGetDevices Lambda** sends the initial message to the **TelegenceDeviceDetailQueueURL** which triggers the **AltaworxTelegenceAWSGetDeviceDetails** Lambda function.

### Processing Flow in AltaworxTelegenceAWSGetDeviceDetails Lambda
1. **Initial Message**: Contains `InitializeProcessing = true` (sent from AltaworxTelegenceAWSGetDevices Lambda)
2. **Subsequent Messages**: Contain `InitializeProcessing = false` and specific `GroupNumber` values (self-generated by AltaworxTelegenceAWSGetDeviceDetails Lambda)

### Message Attributes Structure
```csharp
MessageAttributes = {
    {"InitializeProcessing", new MessageAttributeValue {DataType = "String", StringValue = boolean.ToString()}},
    {"GroupNumber", new MessageAttributeValue {DataType = "String", StringValue = groupNumber.ToString()}}
}
```

### Queue Configuration for AltaworxTelegenceAWSGetDeviceDetails Lambda
- **Queue URL**: Environment variable `TelegenceDeviceDetailQueueURL`
- **Delay**: 5 seconds delay for each queued message
- **Region**: USEast1
- **Example Queue URL**: `https://sqs.us-east-1.amazonaws.com/130265568833/Telegence_Device_Details_TEST`

## 2. Batch Size Limits for Subscribers in AltaworxTelegenceAWSGetDeviceDetails Lambda

### Default Configuration
- **Primary Source**: Environment variable `BatchSize` in AltaworxTelegenceAWSGetDeviceDetails Lambda
- **Configured Value**: 150 (from provided environment variables)
- **Fallback Source**: `context.ClientContext.Environment["BatchSize"]`

### Implementation in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
private int BatchSize = Convert.ToInt32(Environment.GetEnvironmentVariable("BatchSize"));
// Fallback configuration
BatchSize = Convert.ToInt32(context.ClientContext.Environment["BatchSize"]);
```

### Database Query Limit in AltaworxTelegenceAWSGetDeviceDetails Lambda
```sql
SELECT TOP {BatchSize} [SubscriberNumber], [ServiceProviderId] 
FROM [dbo].[TelegenceDeviceDetailIdsToProcess] WITH (NOLOCK) 
WHERE GroupNumber = @GroupNumber AND [IsDeleted] = 0
```

### Usage in Stored Procedure
The BatchSize is passed to the stored procedure `usp_Telegence_Devices_GetDetailFilter` in the **AltaworxTelegenceAWSGetDeviceDetails** Lambda:
```csharp
cmd.Parameters.AddWithValue("@BatchSize", BatchSize);
```

## 3. Exact API Endpoint Called in GetDeviceDetails for AltaworxTelegenceAWSGetDeviceDetails Lambda

### Endpoint Configuration
- **Base URL Template**: Environment variable `TelegenceDeviceDetailGetURL`
- **Configured Template**: `/sp/mobility/lineconfig/api/v1/service/{0}`
- **Parameter**: `{0}` is replaced with the subscriber number

### Complete Endpoint Construction in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
// Step 1: Format the endpoint with subscriber number
string deviceDetailUrl = string.Format(TelegenceDeviceDetailGetURL, subscriberNumber);
// Result: /sp/mobility/lineconfig/api/v1/service/[SubscriberNumber]

// Step 2: Build complete URI in TelegenceAPIClient.GetDeviceDetails
var baseUri = _isProduction ? _authentication.ProductionURL : _authentication.SandboxURL;
var requestUri = new Uri($"{baseUri}{deviceDetailsEndpoint}");
```

### API Call Implementation in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
var apiResult = await client.GetDeviceDetails(deviceDetailUrl, MaxRetries);
```

### TelegenceAPIClient.GetDeviceDetails Method Details
- **HTTP Method**: GET
- **Headers**:
  - `Accept`: `application/json`
  - `app-id`: Client ID from authentication
  - `app-secret`: Client secret from authentication
- **Authentication**: Uses Telegence API authentication (app-id/app-secret headers)
- **Base URL**: Production or Sandbox URL based on environment
- **Full Example**: `https://[BaseURL]/sp/mobility/lineconfig/api/v1/service/1234567890`

## 4. Failed Subscriber Handling in AltaworxTelegenceAWSGetDeviceDetails Lambda

### Retry Strategy
- **Automatic Retries**: Yes, using Polly retry policies
- **API Retries**: `MaxRetries = 5` (configurable per call)
- **SQL Retries**: `MaxRetries = 5` with `RetryDelaySeconds = 5`

### Failure Handling Process in AltaworxTelegenceAWSGetDeviceDetails Lambda

#### API Call Failure:
1. **Logged as exception** with full details
2. **Subscriber removed from queue** via `RemoveDeviceFromQueue()` method
3. **Processing continues** with next subscriber in batch
4. **No reprocessing** - failed subscriber is marked as `IsDeleted = 1`

#### Invalid/Empty Response:
1. **Subscriber removed from queue** via `RemoveDeviceFromQueue()` method
2. **Processing continues** with next subscriber in batch

### Error Logging in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
catch (Exception e)
{
    LogInfo(context, CommonConstants.EXCEPTION, $"Error getting device detail {JsonConvert.SerializeObject(e)}");
    LogInfo(context, CommonConstants.INFO, $"Start RemoveDeviceFromQueue");
    sqlRetryPolicy.Execute(() => RemoveDeviceFromQueue(context.CentralDbConnectionString, groupNumber, subscriberNumber));
    continue;
}
```

### Behavior Summary for AltaworxTelegenceAWSGetDeviceDetails Lambda
- **Failed subscribers**: **Automatically removed** from processing queue
- **Retries**: **Handled automatically** by Polly policies
- **Logging**: **All failures logged** with full exception details
- **Skipping**: **Failed subscribers skipped**, processing continues with remaining subscribers

## 5. Tables for Error/Unprocessed Subscriber Capture in AltaworxTelegenceAWSGetDeviceDetails Lambda

### Primary Processing Table
**Table**: `TelegenceDeviceDetailIdsToProcess`
- **Purpose**: Queue of subscribers to process for the **AltaworxTelegenceAWSGetDeviceDetails** Lambda
- **Key Fields**:
  - `SubscriberNumber`: The subscriber to process
  - `ServiceProviderId`: Associated service provider
  - `GroupNumber`: Batch grouping identifier
  - `IsDeleted`: Marks processed/failed items (0 = pending, 1 = processed/failed)

### Staging Tables Used by AltaworxTelegenceAWSGetDeviceDetails Lambda

#### Success Table
**Table**: `TelegenceDeviceDetailStaging`
- **Purpose**: Temporary storage for **successfully retrieved** device details
- **Populated by**: `TelegenceDeviceDetailSyncTable` DataTable in **AltaworxTelegenceAWSGetDeviceDetails** Lambda
- **Usage**: Contains successfully processed subscriber device details

#### Feature Table  
**Table**: `TelegenceDeviceMobilityFeature_Staging`
- **Purpose**: Temporary storage for device offering codes/features
- **Populated by**: `TelegenceDeviceFeatureSyncTable` DataTable in **AltaworxTelegenceAWSGetDeviceDetails** Lambda
- **Cleanup**: Truncated at start of processing via `TRUNCATE TABLE [dbo].[TelegenceDeviceMobilityFeature_Staging]`

### Error Handling in Database for AltaworxTelegenceAWSGetDeviceDetails Lambda

#### Failed Subscriber Removal
```sql
-- Mark individual failed subscribers as deleted
UPDATE [dbo].[TelegenceDeviceDetailIdsToProcess]
SET [IsDeleted] = 1
WHERE GroupNumber = @GroupNumber AND SubscriberNumber = @SubscriberNumber
```

#### Successful Subscriber Removal  
```sql
-- Mark successfully processed subscribers as deleted
UPDATE [dbo].[TelegenceDeviceDetailIdsToProcess]
SET [IsDeleted] = 1
WHERE GroupNumber = @GroupNumber 
AND SubscriberNumber IN (SELECT SubscriberNumber FROM [dbo].[TelegenceDeviceDetailStaging])
```

### Cleanup Process in AltaworxTelegenceAWSGetDeviceDetails Lambda
1. **Successfully processed subscribers**: Marked as `IsDeleted = 1` after staging
2. **Failed subscribers**: Marked as `IsDeleted = 1` to prevent reprocessing  
3. **Feature staging table**: `TelegenceDeviceMobilityFeature_Staging` truncated at start
4. **No error-specific table**: Errors are logged but not persisted to dedicated error tables

## 6. Polly Retry Configuration for SQL/API Failures in AltaworxTelegenceAWSGetDeviceDetails Lambda

### SQL Retry Policy in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
private static RetryPolicy GetSqlRetryPolicy(KeySysLambdaContext context)
{
    var sqlTransientRetryPolicy = Policy
        .Handle<SqlException>(SqlServerTransientExceptionDetector.ShouldRetryOn)
        .Or<TimeoutException>()
        .WaitAndRetry(MaxRetries,
            retryAttempt => TimeSpan.FromSeconds(RetryDelaySeconds),
            (exception, timeSpan, retryCount, sqlContext) => LogInfo(context, "STATUS",
                $"Encountered transient SQL error - delaying for {timeSpan.TotalMilliseconds}ms, then making retry {retryCount}. Exception: {exception?.Message}"));
    return sqlTransientRetryPolicy;
}
```

### SQL Retry Configuration for AltaworxTelegenceAWSGetDeviceDetails Lambda
- **Max Retries**: 5 (`MaxRetries` constant)
- **Retry Delay**: 5 seconds (`RetryDelaySeconds` constant)
- **Exception Types**:
  - `SqlException` (with transient error detection via `SqlServerTransientExceptionDetector`)
  - `TimeoutException`
- **Strategy**: **Wait and retry with fixed delay**
- **Logging**: Each retry attempt logged with delay time and retry count

### API Retry Policy in TelegenceAPIClient (used by AltaworxTelegenceAWSGetDeviceDetails Lambda)
```csharp
var response = await RetryPolicyHelper.PollyRetryHttpRequestAsync(_logger, retryNumber).ExecuteAsync(async () =>
{
    var request = _httpRequestFactory.BuildRequestMessage(_authentication, new HttpMethod(CommonConstants.METHOD_GET), requestUri,
        new Dictionary<string, string> { 
            { CommonConstants.ACCEPT, CommonConstants.APPLICATION_JSON }, 
            { CommonConstants.APP_ID, _authentication.ClientId }, 
            { CommonConstants.APP_SECRET, _authentication.ClientSecret } 
        });
    return await _httpClientFactory.GetClient().SendAsync(request);
});
```

### API Retry Configuration for AltaworxTelegenceAWSGetDeviceDetails Lambda
- **Max Retries**: 5 (`MaxRetries` constant in **AltaworxTelegenceAWSGetDeviceDetails** Lambda)
- **Retry Helper**: `RetryPolicyHelper.PollyRetryHttpRequestAsync`
- **Default Retries**: `CommonConstants.NUMBER_OF_TELEGENCE_RETRIES` (value: 3)
- **Strategy**: **Polly retry policy with exponential backoff** (implementation in `RetryPolicyHelper`)
- **Override**: **AltaworxTelegenceAWSGetDeviceDetails** Lambda passes `MaxRetries = 5` to override default

### Constants Used in AltaworxTelegenceAWSGetDeviceDetails Lambda
```csharp
private const int MaxRetries = 5;
private const int RetryDelaySeconds = 5;
```

### Retry Policy Usage Pattern in AltaworxTelegenceAWSGetDeviceDetails Lambda
1. **SQL Operations**: Use `GetSqlRetryPolicy()` with 5 retries and 5-second delays
2. **API Operations**: Use `RetryPolicyHelper.PollyRetryHttpRequestAsync()` with 5 retries and exponential backoff
3. **Subscriber Processing**: Each failed subscriber removed after all retry attempts exhausted
4. **Batch Processing**: Continues with next subscriber even if current subscriber fails after all retries

## Summary

The **AltaworxTelegenceAWSGetDeviceDetails** Lambda function operates as a robust batch processing system that:

1. **Receives initial trigger** from **AltaworxTelegenceAWSGetDevices** Lambda via SQS message
2. **Processes subscribers in batches** of 150 (configurable via environment variable)
3. **Calls Telegence API endpoint** `/sp/mobility/lineconfig/api/v1/service/{subscriberNumber}`
4. **Handles failures gracefully** by removing failed subscribers and continuing processing
5. **Uses comprehensive retry policies** (5 retries for both SQL and API operations)
6. **Maintains data integrity** through staging tables and proper cleanup procedures

The Lambda ensures no subscriber is processed twice and provides detailed logging for monitoring and troubleshooting purposes.